# Requirements Document

## Introduction

The `den brew upgrade` command provides automated Homebrew maintenance and backup functionality for the den CLI application. This feature runs `brew upgrade` to update all installed packages, generates a Brewfile snapshot, uses Anthropic's API to document and categorize the Brewfile contents, and backs up the formatted Brewfile to a GitHub Gist. The system tracks changes via content hashing to avoid unnecessary API calls and Gist updates when the Brewfile hasn't changed.

## Glossary

- **den**: The CLI application name, a utility for local machine automations
- **Homebrew**: A package manager for macOS that installs command-line tools and applications
- **Brewfile**: A text file listing all Homebrew-managed packages, casks, taps, and mas applications
- **brew upgrade**: A Homebrew command that updates all installed packages to their latest versions
- **brew bundle dump**: A Homebrew command that generates a Brewfile from currently installed packages
- **GitHub Gist**: A simple way to share snippets and files, accessible via GitHub's API
- **Anthropic API**: The API for Claude AI models, used to generate documentation
- **state.json**: The JSON file at `~/.config/den/state.json` storing application runtime state (e.g., Gist IDs)
- **Content Hash**: A SHA-256 hash of the Brewfile content used to detect changes, stored in state.json
- **API Key**: A secret credential string used to authenticate with external services

## Requirements

### Requirement 1

**User Story:** As a user, I want to run `den brew upgrade` to update my Homebrew packages, so that all my applications stay current.

#### Acceptance Criteria

1. WHEN a user runs `den brew upgrade` THEN the system SHALL execute `brew upgrade` to update all installed packages
2. WHEN `brew upgrade` executes THEN the system SHALL display "Updating Homebrew dependencies..." to indicate progress
3. WHEN `brew upgrade` completes successfully THEN the system SHALL proceed to generate the Brewfile
4. WHEN `brew upgrade` fails THEN the system SHALL display an error message and exit with a non-zero status code

### Requirement 2

**User Story:** As a user, I want a Brewfile generated after upgrading, so that I have a snapshot of my current package configuration.

#### Acceptance Criteria

1. WHEN generating the Brewfile THEN the system SHALL execute `brew bundle dump --force` to create the Brewfile content
2. WHEN generating the Brewfile THEN the system SHALL display "Creating Brewfile..." to indicate progress
3. WHEN the Brewfile is generated THEN the system SHALL compute a SHA-256 hash of the content
4. WHEN the new Brewfile hash matches the hash stored in state.json AND the `--force` flag is not provided THEN the system SHALL skip formatting and backup, displaying "Brewfile unchanged, skipping backup"
5. WHEN the Brewfile hash differs from the stored hash OR no hash exists in state.json THEN the system SHALL proceed to format the Brewfile
6. WHEN the user provides the `--force` flag THEN the system SHALL proceed to format and backup the Brewfile regardless of whether the hash has changed

### Requirement 3

**User Story:** As a user, I want my Brewfile documented with descriptions, so that I can understand what each package does.

#### Acceptance Criteria

1. WHEN formatting the Brewfile THEN the system SHALL send the raw Brewfile content to the Anthropic API
2. WHEN sending to Anthropic THEN the system SHALL display "Formatting Brewfile with AI..." to indicate progress
3. WHEN requesting formatting THEN the system SHALL instruct Anthropic to add a header comment block noting the file was generated by `den` with usage instructions for `brew bundle` and `brew bundle cleanup`
4. WHEN requesting formatting THEN the system SHALL instruct Anthropic to add inline description comments at the end of each package line (using `# description` format)
5. WHEN requesting formatting THEN the system SHALL instruct Anthropic to organize packages into logical categories with decorated section headers (using `# ============` style separators)
6. WHEN the Anthropic API key is not configured THEN the system SHALL display an error message instructing the user to run `den auth login`
7. WHEN the Anthropic API call fails THEN the system SHALL display an error message with details and exit with a non-zero status code
8. WHEN formatting a Brewfile and then parsing the formatted output THEN the system SHALL preserve all original package entries

### Requirement 4

**User Story:** As a user, I want my formatted Brewfile backed up to a GitHub Gist, so that I have a cloud backup of my configuration.

#### Acceptance Criteria

1. WHEN backing up to GitHub THEN the system SHALL create a new Gist if no Gist ID is stored in state.json
2. WHEN backing up to GitHub THEN the system SHALL update the existing Gist if a Gist ID is stored in state.json
3. WHEN backing up THEN the system SHALL display "Backing up Brewfile to GitHub Gist..." to indicate progress
4. WHEN the Gist is created THEN the system SHALL store the Gist ID in state.json under the "brew" key
5. WHEN the Gist operation succeeds THEN the system SHALL display the Gist URL to the user
6. WHEN the GitHub token is not configured THEN the system SHALL display an error message instructing the user to configure GitHub authentication
7. WHEN the GitHub API call fails THEN the system SHALL display an error message with details and exit with a non-zero status code

### Requirement 5

**User Story:** As a user, I want the brew state persisted, so that the system can track changes and Gist ID across runs.

#### Acceptance Criteria

1. WHEN storing brew state THEN the system SHALL save to `~/.config/den/state.json` under the "brew" key
2. WHEN the state.json file does not exist THEN the system SHALL create the file with the brew state
3. WHEN the state.json file exists THEN the system SHALL merge the brew state with existing content
4. WHEN saving brew state THEN the system SHALL store the Brewfile content hash
5. WHEN saving brew state THEN the system SHALL store the GitHub Gist ID after successful backup
6. WHEN serializing brew state to JSON and deserializing it back THEN the system SHALL produce equivalent state values

### Requirement 6

**User Story:** As a user, I want detailed logs of the brew upgrade process, so that I can troubleshoot issues.

#### Acceptance Criteria

1. WHEN the brew upgrade process runs THEN the system SHALL log all operations to `~/.config/den/logs/brew-upgrade.log`
2. WHEN the log directory does not exist THEN the system SHALL create `~/.config/den/logs/` with appropriate permissions
3. WHEN logging THEN the system SHALL include timestamps with each log entry
4. WHEN logging THEN the system SHALL include the log level (INFO, ERROR, WARNING) with each entry
5. WHEN an error occurs THEN the system SHALL log the full error details including stack traces

### Requirement 7

**User Story:** As a user, I want clear progress feedback during the process, so that I know what step is currently executing.

#### Acceptance Criteria

1. WHEN each major step begins THEN the system SHALL display a status message to the console
2. WHEN the entire process completes successfully THEN the system SHALL display a summary message with the Gist URL
3. WHEN the process is skipped due to unchanged Brewfile THEN the system SHALL clearly indicate no backup was needed
4. WHEN any step fails THEN the system SHALL display which step failed and why

